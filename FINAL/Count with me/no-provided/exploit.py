from pwn import xor
from Crypto.Cipher import AES
from Crypto.Util import Counter

with open("output.txt", "r") as f:
    full = f.readlines()
    f = [e.strip() for e in full]
    ct_ch = [e.split(" | ") for e in f[:-2]]
    nonces = [xor(bytes.fromhex(i[0]), bytes.fromhex(i[1])) for i in ct_ch]
    nonce = nonces[0]
    ctr = Counter.new(128)
    c = AES.new(nonce*2, AES.MODE_CTR, counter=ctr)
    ct = bytes.fromhex(f[-2])
    ctr2 = Counter.new(128)
    c2 = AES.new(nonce*2, AES.MODE_CTR, counter=ctr2)
    key = c2.decrypt(xor(c.encrypt(ct), bytes.fromhex(f[-1])))[:16]
    ctr = Counter.new(128)
    cipher = AES.new(key, AES.MODE_CTR, counter=ctr)
    decrypted_data = cipher.decrypt(ct)
    print(decrypted_data)